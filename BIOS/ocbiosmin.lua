local a={}local b=component;local c=computer;c.setArchitecture("Lua 5.3")local d=b.proxy(b.list("eeprom",true)())local e,f,g=1,2,4;local string=string;local function h()local i=d.getData()if#i==0 then a[e]=false;a[_ID_SHOW_LOGO]=true end;while#i>0 do local j,k=string.unpack("<I1I1",i)i=i:sub(3)a[j]=assert(load("return "..string.unpack("<c"..k,i:sub(1,k)),"=(config)"))()i=i:sub(k+1)end end;local function l()local i=""for j,m in pairs(a)do if type(m)=="string"then m=string.format("'%s'",m)end;m=tostring(m)local n=string.pack("<I1I1c"..#m,j,#m,m)i=i..n end;if#i>256 then error("configuration over 256 bytes!")end;d.setData(i)end;local o={}local p=b.proxy(b.list("gpu",true)())p.bind(b.list("screen",true)())local q=p.setForeground;local r=p.setBackground;local s=p.set;do local t,u=1,1;local function v()local w,x=p.getResolution()if t>w then t,u=1,u+1 end;if u>x then p.copy(1,1,w,x,0,-1)p.fill(1,x,w,1," ")u=x end;if t<1 then t=w;u=u-1 end;if u<1 then u=1 end end;local function y(z)local w,x=p.getResolution()while#z>0 do v()local A=z:sub(1,w-t+1)z=z:sub(#A+1)s(t,u,A)t=t+#A end end;function o.read(B,C)local D=""local E,F=B or t,C or u;local function G()t,u=E,F;y(D.."_ ")end;while true do G()local H,I,J,K=c.pullSignal()if H=="key_down"then if J>31 and J<127 then D=D..string.char(J)elseif J==8 then D=D:sub(1,-2)elseif J==13 then t,u=E,F;y(D.." ")return D end end end end end;h()l()if a[e]=="true"then _G.term=o end;local L=a[g]or 5;local M=0xDC0000;q(M)local w,x=p.getResolution()p.fill(1,1,w,x," ")s(1,1,"┏━━━━┓")s(1,2,"┃ ╭╮ ┃")s(1,3,"┃ ╰╯ ┃")s(1,4,"┗━━━━┛")q(0xFFFFFF)s(8,2,"OC-BIOS version 0.1.0")s(8,3,"Copyright (c) 2020 Ocawesome101, GNU GPLv3.")local N,O=c.totalMemory(),c.freeMemory()s(1,5,string.format("\n%dK total, %dK free\n\n",N//1024,O//1024))local function P(z,w)z=z:sub(1,w)z=z..string.rep(" ",w-unicode.len(z))return z end;local function Q(R,S)S=S or"Please choose one:"p.fill(1,1,w,x," ")q(M)s(1,1,S)local T=1;local U={[200]=function()if T>1 then T=T-1 else T=#R end end,[208]=function()if T<#R then T=T+1 else T=1 end end}while true do for V=1,#R,1 do local W="  "if T==V then W="⇝ "q(0x000000)r(M)else r(0x000000)q(M)end;s(2,V+2,W..P(R[V],w-8))end;local H,I,I,K=c.pullSignal()if H=="key_down"then if U[K]then U[K]()elseif K==28 then break end end end;p.fill(1,1,w,x," ")return R[T]end;local function X(Y)local Z=b.proxy(Y)if not Z.exists("init.lua")then return nil,"init.lua not present"end;local _,i,a0,a1=Z.open("init.lua"),""repeat local a2=Z.read(_,math.huge)i=i..(a2 or"")until not a2;Z.close(_)local a0,a1=load(i,"=(init)")if not a0 then return nil,a1 end;return pcall(a0)end;local function a3(Y)local Z=b.proxy(Y)local a4=Z.readSector(1):gsub("\0","")local a0,a1=load(a4,"=(bootsector)")if not a0 then return nil,a1 end;return pcall(a0)end;s(1,x,"Press F6 for Config")s(w,x,""..L)local function a5()r(M)q(0x000000)p.fill(1,x//2-1,w,3," ")q(M)r(0x000000)p.fill(1,x//2,w,1," ")return o.read(1,x//2)end;local function a6()local R;while true do R={"Set menu timeout","Expose term API ("..tostring(a[e])..")","Clear boot address","Exit"}local V=Q(R,"OC-BIOS Settings")if V==R[1]then a[g]=tonumber(a5())or L elseif V==R[2]then a[e]=not a[e]elseif V==R[3]then a[f]=nil elseif V==R[4]then l()c.shutdown(true)end end end;local a7=c.uptime()+L;repeat local H,I,I,K=c.pullSignal(math.min(1,c.uptime()-a7))if H=="key_down"and K==64 then a6()end;s(w,x,""..a7-c.uptime()//1)until c.uptime()>=a7;s(1,7,"Detecting drives...")local a8=b.list("filesystem",true)local a9=b.list("drive",true)a8[c.tmpAddress()]=nil;local aa={}for Y in a8 do aa[#aa+1]=Y end;for Y in a9 do aa[#aa+1]=Y end;s(20,7,"done.")if not a[f]or not component.type(a[f])then local ab=Q(aa,"Please select a boot device:")a[f]=ab;l()end;function c.getBootAddress()return a[f]end;function c.setBootAddress(B)a[f]=B;l()end;local Y=a[f]while true do local a0,a1;if component.type(Y)=="drive"then a0,a1=a3(Y)else a0,a1=X(Y)end;if not a0 and a1 then s(1,10,"Boot failed: "..a1)end;repeat local H=c.pullSignal()until H=="key_down"end
